# cspell:words webfactory endssh
name: Setup Server

on:
  workflow_dispatch: # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· GitHub UI

jobs:
  setup:
    name: Setup Server Dependencies
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Install dependencies on server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
        run: |
          echo "ðŸš€ Starting server setup..."

          ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            
            echo "ðŸ“¦ Updating system packages..."
            sudo apt-get update -qq
            
            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° curl Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚, ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
            echo "ðŸ”§ Installing required utilities..."
            sudo apt-get install -y -qq curl unzip
            
            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js (LTS Ð²ÐµÑ€ÑÐ¸Ñ Ñ‡ÐµÑ€ÐµÐ· NodeSource)
            if ! command -v node &> /dev/null; then
              echo "ðŸ“¥ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
              sudo apt-get install -y -qq nodejs
              echo "âœ… Node.js installed: $(node --version)"
            else
              echo "âœ… Node.js already installed: $(node --version)"
            fi
            
            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Bun
            if ! command -v bun &> /dev/null; then
              echo "ðŸ“¥ Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              
              # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Bun Ð² PATH Ð´Ð»Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÑÐµÑÑÐ¸Ð¸
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
              
              # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Bun Ð² PATH Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ð¾
              if ! grep -q 'BUN_INSTALL' ~/.bashrc; then
                echo 'export BUN_INSTALL="$HOME/.bun"' >> ~/.bashrc
                echo 'export PATH="$BUN_INSTALL/bin:$PATH"' >> ~/.bashrc
              fi
              
              # Ð”Ð»Ñ zsh, ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ
              if [ -f ~/.zshrc ] && ! grep -q 'BUN_INSTALL' ~/.zshrc; then
                echo 'export BUN_INSTALL="$HOME/.bun"' >> ~/.zshrc
                echo 'export PATH="$BUN_INSTALL/bin:$PATH"' >> ~/.zshrc
              fi
              
              echo "âœ… Bun installed: $($HOME/.bun/bin/bun --version)"
            else
              echo "âœ… Bun already installed: $(bun --version)"
            fi
            
            # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2 Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾
            if ! command -v pm2 &> /dev/null; then
              echo "ðŸ“¥ Installing PM2..."
              sudo npm install -g pm2
              
              # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PM2 Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
              sudo pm2 startup systemd -u ${USER} --hp ${HOME} || true
              
              echo "âœ… PM2 installed: $(pm2 --version)"
            else
              echo "âœ… PM2 already installed: $(pm2 --version)"
            fi
            
            echo ""
            echo "ðŸŽ‰ Server setup completed successfully!"
            echo ""
            echo "ðŸ“Š Installed versions:"
            echo "  - Node.js: $(node --version)"
            echo "  - npm: $(npm --version)"
            echo "  - Bun: $($HOME/.bun/bin/bun --version 2>/dev/null || bun --version)"
            echo "  - PM2: $(pm2 --version)"
          ENDSSH

          echo "âœ… Setup completed!"
