# cspell:words webfactory
name: ðŸš€ Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸš€ Deploy to production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: ðŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸš€ Deploy to server
        env:
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_REF: ${{ github.sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          BOT_API_KEY: ${{ secrets.BOT_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GIGACHAT_AUTH_KEY: ${{ secrets.GIGACHAT_AUTH_KEY }}
          YOOKASSA_SECRET_KEY: ${{ secrets.YOOKASSA_SECRET_KEY }}
          YOOKASSA_SHOP_ID: ${{ secrets.YOOKASSA_SHOP_ID }}
          SSL_CERT_PEM: ${{ secrets.SSL_CERT_PEM }}
          SSL_KEY_PEM: ${{ secrets.SSL_KEY_PEM }}
        run: |
          ssh -p 22 -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" \
            GITHUB_REPO="${GITHUB_REPO}" \
            GITHUB_REF="${GITHUB_REF}" \
            GITHUB_TOKEN="${GITHUB_TOKEN}" \
            DB_HOST="${DB_HOST}" \
            DB_PORT="${DB_PORT}" \
            DB_USER="${DB_USER}" \
            DB_PASSWORD="${DB_PASSWORD}" \
            DB_NAME="${DB_NAME}" \
            BOT_TOKEN="${BOT_TOKEN}" \
            BOT_API_KEY="${BOT_API_KEY}" \
            JWT_SECRET="${JWT_SECRET}" \
            GIGACHAT_AUTH_KEY="${GIGACHAT_AUTH_KEY}" \
            YOOKASSA_SECRET_KEY="${YOOKASSA_SECRET_KEY}" \
            YOOKASSA_SHOP_ID="${YOOKASSA_SHOP_ID}" \
            SSL_CERT_PEM="$(echo -n "$SSL_CERT_PEM" | base64 -w 0)" \
            SSL_KEY_PEM="$(echo -n "$SSL_KEY_PEM" | base64 -w 0)" \
            "bash -s" < .github/scripts/deploy.sh
