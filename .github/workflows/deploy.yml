# cspell:words webfactory
name: Deploy to Server

on:
  workflow_dispatch: # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· GitHub UI

jobs:
  deploy:
    name: Deploy Snappy Bot
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
          USE_PM2: ${{ secrets.USE_PM2 || 'true' }}
          SNAPPY_CONFIG_JSON: ${{ secrets.SNAPPY_CONFIG }}
        run: |
          echo "ðŸš€ Starting deployment..."

          # ÐšÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð² base64, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð°
          if [ -n "${SNAPPY_CONFIG_JSON}" ]; then
            echo "ðŸ” Encoding SNAPPY_CONFIG to base64..."
            SNAPPY_CONFIG_B64=$(echo -n "${SNAPPY_CONFIG_JSON}" | base64 -w 0)
          else
            echo "âš ï¸  Warning: SNAPPY_CONFIG secret is not set. Make sure config.json exists on the server."
            SNAPPY_CONFIG_B64=""
          fi

          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ, ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
          echo "ðŸ“ Ensuring remote directory exists..."
          ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
            "mkdir -p ${REMOTE_PATH}"

          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²
          echo "ðŸ“¦ Syncing files..."
          rsync -avz --delete \
            -e "ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no" \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.jscpd' \
            --exclude='bun.lockb' \
            --exclude='*.log' \
            --exclude='.vscode' \
            --exclude='deploy.config.json' \
            --exclude='.env' \
            --exclude='*.bat' \
            --exclude='.DS_Store' \
            ./ ${SSH_USER}@${SSH_HOST}:${REMOTE_PATH}/

          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
          echo "ðŸ“¥ Installing dependencies..."
          ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
            "cd ${REMOTE_PATH} && export PATH=\"\$HOME/.bun/bin:\$PATH\" && bun install --production"

          # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
          if [ "${USE_PM2}" = "true" ]; then
            echo "ðŸ”„ Restarting with PM2..."
            if [ -n "${SNAPPY_CONFIG_B64}" ]; then
              ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
                "cd ${REMOTE_PATH} && export PATH=\"\$HOME/.bun/bin:\$PATH\" && \
                 pm2 delete snappy-bot 2>/dev/null || true && \
                 cd packages/snappy && \
                 SNAPPY_CONFIG=\"${SNAPPY_CONFIG_B64}\" pm2 start \"\$HOME/.bun/bin/bun\" --name snappy-bot --update-env -- run start && \
                 pm2 save"
            else
              ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
                "cd ${REMOTE_PATH} && export PATH=\"\$HOME/.bun/bin:\$PATH\" && \
                 pm2 delete snappy-bot 2>/dev/null || true && \
                 cd packages/snappy && \
                 pm2 start \"\$HOME/.bun/bin/bun\" --name snappy-bot -- run start && \
                 pm2 save"
            fi
            
            echo "ðŸ“Š PM2 Status:"
            ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
              "pm2 status snappy-bot"
          else
            echo "ðŸ”„ Restarting with systemd..."
            if [ -n "${SNAPPY_CONFIG_B64}" ]; then
              ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
                "sudo mkdir -p /etc/systemd/system/snappy-bot.service.d && \
                 echo '[Service]' | sudo tee /etc/systemd/system/snappy-bot.service.d/env.conf && \
                 echo 'Environment=\"SNAPPY_CONFIG=${SNAPPY_CONFIG_B64}\"' | sudo tee -a /etc/systemd/system/snappy-bot.service.d/env.conf && \
                 sudo systemctl daemon-reload && \
                 sudo systemctl restart snappy-bot"
            else
              ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
                "sudo systemctl restart snappy-bot"
            fi
            
            echo "ðŸ“Š Service Status:"
            ssh -p ${SSH_PORT} -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
              "sudo systemctl status snappy-bot --no-pager -l"
          fi

          echo "âœ… Deployment completed successfully!"
